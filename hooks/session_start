#!/bin/bash
# Claude hook: Track which Claude session is running in which tmux session
# Install: cp this file to ~/.claude/hooks/session_start && chmod +x ~/.claude/hooks/session_start

if [ -n "$TMUX" ] && [ -n "$CLAUDE_SESSION_ID" ]; then
  tmux_session=$(tmux display-message -p '#S')
  project_path=$(pwd)
  path_key=$(echo "$project_path" | tr '/' '-')

  sessions_dir="$HOME/.local/share/dev-sessions/$path_key/sessions"
  session_file="$sessions_dir/$tmux_session.json"

  if [ -f "$session_file" ]; then
    # Update existing session metadata with Claude session ID
    # Using a temp file for atomic update
    tmp_file=$(mktemp)
    if command -v jq &> /dev/null; then
      jq --arg id "$CLAUDE_SESSION_ID" '.claudeSessionId = $id' "$session_file" > "$tmp_file" && mv "$tmp_file" "$session_file"
    else
      # Fallback: simple sed replacement if jq not available
      if grep -q '"claudeSessionId"' "$session_file"; then
        sed -i.bak "s/\"claudeSessionId\": \"[^\"]*\"/\"claudeSessionId\": \"$CLAUDE_SESSION_ID\"/" "$session_file"
        rm -f "$session_file.bak"
      else
        # Add claudeSessionId before the last }
        sed -i.bak "s/}$/,\"claudeSessionId\": \"$CLAUDE_SESSION_ID\"}/" "$session_file"
        rm -f "$session_file.bak"
      fi
    fi
  fi
fi
